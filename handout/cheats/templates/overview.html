{% import "wtf.jinja" as wtf %} {% extends "base.html" %} {% block content %}

{% set map_styles = ({"base":"color: purple", "beach":"color: teal", "ocean":"color: blue", "cloud":"color: #00BFFF", "ruins":"color: brown"})	%}

{% macro item_header(item) %}
<div class="is-flex is-justify-content-space-between is-align-items-center">
  <span style="{{ map_styles[item.mapname] or '#262124' }}">{{ item.mapname }}</span>
  <span>
    <button disabled class="button px-2 py-1">üëÄ Show</button>
    {% if item.tracking %}
    <button class="button px-2 py-1" style="background-color: rgb(255, 198, 198);" onclick="trackObject('{{ item.mapname }}','{{ item.obj.nametype }}','{{ item.obj.name or item.obj.map_name }}')">‚õîÔ∏è Untrack</button>
    {% else %}
    <button class="button px-2 py-1" onclick="trackObject('{{ item.mapname }}','{{ item.obj.nametype }}','{{ item.obj.name or item.obj.map_name }}')">üéØ Track</button>
    {% endif %}
  </span>
</div>
{%- endmacro %}

<div class="grid is-col-min-12" style="grid-template-rows: masonry;">
  {% if state %}
  <div class="cell box is-dark theme-colors-light is-align-self-baseline">
    <h1 class="title is-5">Flags</h1>
    <div class="content">
    {% for flag in state.flags %}
      {{ item_header(flag) }}
      <p class="mt-2" style="text-align: center;">
        <span class="title is-6">{{ flag.obj.name }}{% if flag.obj.nametype == "BossGate" %} needs <span style="white-space: nowrap;">{{ flag.obj.stars_needed }} ‚≠ê</span>{% endif %}: <span style="white-space: nowrap;">{{ flag.stars }} ‚≠ê</span></span>
      </p>
      {% if not loop.last %}
      <hr class="theme-colors"/>
      {% endif %}
    {% endfor %}
    </div>
  </div>
  <div class="cell box is-dark theme-colors-light is-align-self-baseline">
    <h1 class="title is-5">Coins</h1>
    {% for coin in state.coins %}
    <div>
      {{ item_header(coin) }}
      <p class="mt-2" style="text-align: center;">
        <span class="title is-6">{{ coin.obj.display_name }} üíµ {{ coin.obj.name }}</span>
      </p>
    </div>
    {% if not loop.last %}
    <hr class="theme-colors my-2"/>
    {% endif %}
    {% endfor %}
  </div>
  <div class="cell box is-dark theme-colors-light is-align-self-baseline">
    <h1 class="title is-5">NPCs</h1>
    {% for npc in state.npcs %}
    <div>
      {{ item_header(npc) }}
      <p class="mt-2" style="text-align: center;">
        <span class="title is-6">{{ npc.obj.name }}</span>
      </p>
    </div>
    {% if not loop.last %}
    <hr class="theme-colors my-2"/>
    {% endif %}
    {% endfor %}
  </div>
  <div class="cell box is-dark theme-colors-light is-align-self-baseline">
    <h1 class="title is-5">Items</h1>
    {% for item in state.items %}
    <div>
      {{ item_header(item) }}
      <p class="mt-2" style="text-align: center;">
        <span class="title is-6">{{ item.obj.name }}</span>
      </p>
    </div>
    {% if not loop.last %}
    <hr class="theme-colors my-2"/>
    {% endif %}
    {% endfor %}
  </div>
  <div class="cell box is-dark theme-colors-light is-align-self-baseline">
    <h1 class="title is-5">Warps</h1>
    {% for warp in state.warps %}
    <div>
      {{ item_header(warp) }}
      <p class="mt-2" style="text-align: center;">
        <span class="title is-6">üåÄ warp to {% if warp.mapname == "base" %}<span style="{{ map_styles[warp.obj.map_name] or '#262124' }}">{{ warp.obj.map_name }}</span>{% else %}<span style="{{ map_styles['base'] or '#262124' }}">base</span>{% endif %}</span>
      </p>
    </div>
    {% if not loop.last %}
    <hr class="theme-colors my-2"/>
    {% endif %}
    {% endfor %}
  </div>
  {% else %}
  <section class="section">
    <div class="container">
      <h1 class="title has-text-warning">No game state available, wait a bit</h1>
    </div>
  </section>
  {% endif %}
</div>

<div class="container">
  <h1 class="title is-2 text-light" style="text-align: center;">Maps</h1>
  <div class="tabs is-centered">
    <ul>
      <li class="is-active"><a style="color: var(--theme); border-color: var(--theme);" onclick="changeMap(this)" class="subtitle" data-mapname="base">Base</a></li>
      <li><a style="color: var(--foreground);" onclick="changeMap(this)" class="subtitle" data-mapname="beach">Beach</a></li>
      <li><a style="color: var(--foreground);" onclick="changeMap(this)" class="subtitle" data-mapname="ocean">Ocean</a></li>
      <li><a style="color: var(--foreground);" onclick="changeMap(this)" class="subtitle" data-mapname="cloud">Cloud</a></li>
      <li><a style="color: var(--foreground);" onclick="changeMap(this)" class="subtitle" data-mapname="ruins">Ruins</a></li>
    </ul>
  </div>
  <div class="is-flex is-justify-content-center">
    <img id="mapimg" style="width: 100%; height: auto;"/>
  </div>
</div>

<script>
  let selectedMap = "base";
  let selectedMapElement = document.querySelector(".tabs ul li.is-active a");

  function trackObject(mapname, objnametype, objname) {
    fetch(`/track`, { 
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({
        mapname: mapname,
        objnametype: objnametype,
        objname: objname,
      }),
    }).then(() => {
      window.location.reload();
    });
  }

  function changeMap(e) {
    selectedMapElement.style = "";
    selectedMapElement.style.color = "var(--foreground)";
    selectedMapElement.parentElement.classList.remove("is-active");

    e.style = "";
    e.style.color = "var(--theme)";
    e.style.borderColor = "var(--theme)";
    e.parentElement.classList.add("is-active");

    selectedMapElement = e;
    selectedMap = e.dataset.mapname;
    window.mapimg.src = `/maps/${selectedMap}.jpeg`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    window.mapimg.src = `/maps/${selectedMap}.jpeg`;
  });
</script>
{% endblock %}
